<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>index首頁</title>
  </head>
  <body>

<div class="container has-bottom-pad bg-scene page-wrapper">
  <div class="row">
    <div class="col-12 d-flex flex-column ">
      <!-- 頂部：問候 -->
      <div id="greet" class="d-flex justify-content-between align-items-start mt-top">
        <div class="">
          <h1 class="text-primary-700 fw-bold fs-6 mb-1">Hi, Sarah</h1>
          <p class="fs-12 text-primary-700 mb-0">與 Mofu 相遇的第 17 天</p>
        </div>
        <a href="https://snoesugar.github.io/Mofu-Diary/growth-record.html"><img src="../assets/images/icons/icon_pet.png" alt="icon_pet"></a>
      </div>
      <!-- 場景：背景圖 + 貓 + ZZZ -->
      <div class="mx-auto">
        <div class="speech p-1 px-2 d-inline-block bg-neutral-0 rounded-top-xs rounded-bottom-right-xs shadow-sm">
          <p class="fs-12 text-primary-600 mb-0 ">ZZZ.......</p>
        </div>
        <div class="cat-slot">
          <img src="../assets/images/cat/action_cat_sleep2.png" alt="action_cat_sleep2">
        </div>
      </div>
    </div>
  </div>
</div>

<aside id="relaxPanel" class="relax-panel">
  <div class="scene-footer d-flex align-items-start">
    <button class="tag-btn d-flex align-items-center" type="button" aria-expanded="true" aria-controls="relaxPanel">
      <img src="../assets/images/icons/icon_calendar_date.png" alt="icon_calendar_date" width="20" height="20">
      <span class="fs-9 text-primary-600 fw-bold ms-1">我的放鬆行程</span>
    </button>

    <div id="progressWrap" class="w-100">
      <%- include('./layout/progress'); -%>
      <!-- 任務完成 -->
      <div id="taskDoneCard" class="task-card px-4 py-2 me-4 rounded-2 d-flex justify-content-between align-items-center flex-grow-1 border border-1 border-white" hidden>
        <div><h6 class="m-0 text-accent-500 fs-13">今日任務已完成</h6></div>
        <div>
          <svg width="24" height="24" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M0 15C0 6.71573 6.71573 0 15 0C23.2843 0 30 6.71573 30 15C30 23.2843 23.2843 30 15 30C6.71573 30 0 23.2843 0 15Z" fill="#86B42E"/>
            <path d="M9 14.7632L13.1379 19.5L21 10.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- 抽屜內容 -->
  <div class="scene-body">
    <div class="container has-bottom-pad body page-wrapper">
      <div class="row">
        <div class="col-12 d-flex flex-column">
          <div class="mt-4 mb-5 d-flex">
            <%- include('./layout/mood-picker-inline'); -%>
            <%- include('./layout/energy-index'); -%>
          </div>

          <div class="mb-5 rounded-3">
            <%- include('./layout/breathing-exercises'); -%>
          </div>

          <div class="mb-5">
            <h3 class="fs-11 text-primary-600 mb-2">和 Mofu 分享我的一天...</h3>
            <%- include('./layout/myday-diary-cards'); -%>
            <button id="add-photos-trigger" type="button"
              class="btn w-100 text-start border-1 border-neutral-100 bg-primary-100 p-3 rounded-3 d-flex justify-content-center align-items-center mb-1"
              aria-haspopup="dialog" aria-controls="add-photos-sheet" aria-expanded="false">
              <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M24 32.8206C26.0103 32.8206 27.7128 32.1232 29.1077 30.7283C30.5026 29.3334 31.2 27.6309 31.2 25.6206C31.2 23.6103 30.5026 21.9078 29.1077 20.5129C27.7128 19.118 26.0103 18.4206 24 18.4206C21.9897 18.4206 20.2872 19.118 18.8923 20.5129C17.4974 21.9078 16.8 23.6103 16.8 25.6206C16.8 27.6309 17.4974 29.3334 18.8923 30.7283C20.2872 32.1232 21.9897 32.8206 24 32.8206ZM23.9918 29.7437C22.8349 29.7437 21.8598 29.3471 21.0667 28.5539C20.2735 27.7608 19.8769 26.7857 19.8769 25.6288C19.8769 24.4722 20.2735 23.4944 21.0667 22.6955C21.8598 21.8968 22.8349 21.4975 23.9918 21.4975C25.1484 21.4975 26.1262 21.8968 26.9251 22.6955C27.7238 23.4944 28.1231 24.4722 28.1231 25.6288C28.1231 26.7857 27.7238 27.7608 26.9251 28.5539C26.1262 29.3471 25.1484 29.7437 23.9918 29.7437ZM11.0769 38.3591C10.2307 38.3591 9.50632 38.0578 8.90379 37.4553C8.30126 36.8527 8 36.1284 8 35.2821V15.9796C8 15.1334 8.30126 14.409 8.90379 13.8064C9.50632 13.2039 10.2307 12.9027 11.0769 12.9027H16.2462L18.2769 10.6668C18.5625 10.3511 18.9064 10.1013 19.3087 9.91722C19.711 9.73315 20.1329 9.64111 20.5744 9.64111H27.4256C27.8671 9.64111 28.289 9.73315 28.6913 9.91722C29.0936 10.1013 29.4375 10.3511 29.7231 10.6668L31.7538 12.9027H36.9231C37.7693 12.9027 38.4937 13.2039 39.0962 13.8064C39.6987 14.409 40 15.1334 40 15.9796V35.2821C40 36.1284 39.6987 36.8527 39.0962 37.4553C38.4937 38.0578 37.7693 38.3591 36.9231 38.3591H11.0769Z" fill="#BC8035"/>
              </svg>
              <p class="mb-0 fs-11 text-primary-700">新增照片</p>
            </button>
            <p id="uploaded-counter" class="fs-12 text-primary-700 mb-0">已上傳 0 / 3 張</p>
            <div id="uploaded-thumbs" class="mt-2" hidden></div>
          </div>

          <button id="saveDiaryBtn" type="button" class="btn text-neutral-0 bg-primary-500 mb-2 rounded-5" 
            data-bs-toggle="modal" data-bs-target="#diary-save">儲存
          </button>
          <a class="btn text-primary-700 border-1 border-primary-700 rounded-5 mb-6" href="edit-itinerary.html">編輯行程</a> 
        </div>
      </div>
    </div>
    <%- include('./layout/footer'); -%>
  </div>
</aside>

<!-- 完成日記編輯Modal -->
<div class="modal fade" id="diary-save" tabindex="-1" aria-labelledby="diary-saveLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="border-0 bg-neutral-0 custom-modal-save rounded-s custom-yellow-save d-flex flex-column">
      <button type="button" class="btn-close m-4" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="text-center">
        <img src="/assets/images/save/saved_successfully.png" class="mb-2 mt-n8" alt="saved_successfully">
        <p class="fs-11 text-primary-600 fw-bold mb-2">儲存成功</p>
        <svg width="30" height="30" viewBox="0 0 30 30" class="mb-2" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M0 15C0 6.71573 6.71573 0 15 0C23.2843 0 30 6.71573 30 15C30 23.2843 23.2843 30 15 30C6.71573 30 0 23.2843 0 15Z" fill="#86B42E"/>
          <path d="M9 14.7632L13.1379 19.5L21 10.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <button type="button" id="goHomeAfterSave" class="btn btn-primary mb-3 mx-5" data-bs-dismiss="modal">回首頁</button>
    </div>
  </div>
</div>

<!-- add-photos sheet -->
<div class="add-photos" id="add-photos-sheet" data-sheet-h="589" data-max="3" aria-hidden="true"
role="dialog" aria-modal="true" aria-labelledby="ap-title">
  <div class="d-flex align-items-center justify-content-around px-3 pt-3">
    <button type="button" id="add-photos-Close" class="ap-back btn p-0" aria-label="Close">
      <svg width="49" height="48" viewBox="0 0 49 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M27.5 18L21.5 23.9994L27.5 30" stroke="#BC8035" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <div id="ap-title" class="ap-title fs-11 text-primary-700 m-0">已選擇 <span id="ap-count">0</span> 張照片</div>
    <div class="ap-icon" aria-hidden="true">
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M24 32.8206C26.0103 32.8206 27.7128 32.1232 29.1077 30.7283C30.5026 29.3334 31.2 27.6309 31.2 25.6206C31.2 23.6103 30.5026 21.9078 29.1077 20.5129C27.7128 19.118 26.0103 18.4206 24 18.4206C21.9897 18.4206 20.2872 19.118 18.8923 20.5129C17.4974 21.9078 16.8 23.6103 16.8 25.6206C16.8 27.6309 17.4974 29.3334 18.8923 30.7283C20.2872 32.1232 21.9897 32.8206 24 32.8206ZM23.9918 29.7437C22.8349 29.7437 21.8598 29.3471 21.0667 28.5539C20.2735 27.7608 19.8769 26.7857 19.8769 25.6288C19.8769 24.4722 20.2735 23.4944 21.0667 22.6955C21.8598 21.8968 22.8349 21.4975 23.9918 21.4975C25.1484 21.4975 26.1262 21.8968 26.9251 22.6955C27.7238 23.4944 28.1231 24.4722 28.1231 25.6288C28.1231 26.7857 27.7238 27.7608 26.9251 28.5539C26.1262 29.3471 25.1484 29.7437 23.9918 29.7437ZM11.0769 38.3591C10.2307 38.3591 9.50632 38.0578 8.90379 37.4553C8.30126 36.8527 8 36.1284 8 35.2821V15.9796C8 15.1334 8.30126 14.409 8.90379 13.8064C9.50632 13.2039 10.2307 12.9027 11.0769 12.9027H16.2462L18.2769 10.6668C18.5625 10.3511 18.9064 10.1013 19.3087 9.91722C19.711 9.73315 20.1329 9.64111 20.5744 9.64111H27.4256C27.8671 9.64111 28.289 9.73315 28.6913 9.91722C29.0936 10.1013 29.4375 10.3511 29.7231 10.6668L31.7538 12.9027H36.9231C37.7693 12.9027 38.4937 13.2039 39.0962 13.8064C39.6987 14.409 40 15.1334 40 15.9796V35.2821C40 36.1284 39.6987 36.8527 39.0962 37.4553C38.4937 38.0578 37.7693 38.3591 36.9231 38.3591H11.0769Z" fill="#BC8035"/>
      </svg>
    </div>
  </div>
  <ul class="ap-grid">
    <li><img src="../assets/images/add-photos/Frame1.png"  alt=""></li>
    <li><img src="../assets/images/add-photos/Frame2.png"  alt=""></li>
    <li><img src="../assets/images/add-photos/Frame3.png"  alt=""></li>
    <li><img src="../assets/images/add-photos/Frame4.png"  alt=""></li>
    <li><img src="../assets/images/add-photos/Frame5.png"  alt=""></li>
    <li><img src="../assets/images/add-photos/Frame6.png"  alt=""></li>
    <li><img src="../assets/images/add-photos/Frame7.png"  alt=""></li>
    <li><img src="../assets/images/add-photos/Frame8.png"  alt=""></li>
    <li><img src="../assets/images/add-photos/Frame9.png"  alt=""></li>
    <li><img src="../assets/images/add-photos/Frame10.png" alt=""></li>
    <li><img src="../assets/images/add-photos/Frame11.png" alt=""></li>
    <li><img src="../assets/images/add-photos/Frame12.png" alt=""></li>
  </ul>
  <button id="add-photos-save" class="ap-cta-overlay btn border-0 text-neutral-0 bg-primary-500 rounded-5" disabled>
    確認上傳
  </button>
</div>

<script type="module" src="../main.js"></script>

<!-- 底部導覽：第二個 active -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const navBtns = document.querySelectorAll(".btn-nav-bottom");
  if (navBtns.length > 1) {
    navBtns[1].classList.add("active"); // 第二個
  }
});
</script>

<!-- relaxPanel：統一計算（展開預設 on） -->
<script>
(() => {
  const root  = document.documentElement;
  const panel = document.getElementById('relaxPanel');
  const OPEN_GAP = 8;
  if (!panel) return;

  // 統一 DOM 參照，避免重複宣告
  const sceneEl      = document.querySelector('.bg-scene');
  const greetEl      = document.getElementById('greet');
  const sceneFooterEl= panel.querySelector('.scene-footer');

  const px = n => Math.round(n) + 'px';

  function applyState(){
    const isOpen = panel.classList.contains('is-open');
    const t = isOpen ? panel.dataset.openTop : panel.dataset.collapsedTop;
    document.documentElement.classList.toggle('panel-open', isOpen);
    if(t) root.style.setProperty('--panel-top', px(+t));
  }

  function measure(){
    const scene = document.querySelector('.bg-scene');
    const greet = document.getElementById('greet');
    const head  = panel.querySelector('.scene-footer');
    if(!scene || !greet || !head) return;

    const headH = Math.round(head.offsetHeight || 52);
    root.style.setProperty('--panel-head-h', px(headH));

    const sb = scene.getBoundingClientRect();
    const gb = greet.getBoundingClientRect();

    const collapsedTop = Math.round(sb.top + sb.height - headH);
    const openTop      = Math.max(0, Math.round(gb.bottom + OPEN_GAP));

    panel.dataset.collapsedTop = collapsedTop;
    panel.dataset.openTop = openTop;

    applyState();
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.tag-btn');
    if(!btn) return;
    const isOpen = panel.classList.toggle('is-open');
    btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    measure();
  });

  panel.classList.remove('is-open');
  panel.querySelector('.tag-btn')?.setAttribute('aria-expanded','false');
  measure();

  const onScroll = () => panel.classList.contains('is-open') && measure();
  ['resize','orientationchange','scroll'].forEach(evt => window.addEventListener(evt, onScroll, {passive:true}));

  const ro = new ResizeObserver(measure);
  const sceneFooter = panel.querySelector('.scene-footer');
  const greet = document.getElementById('greet');
  const scene = document.querySelector('.bg-scene');
  sceneFooter && ro.observe(sceneFooter);
  greet && ro.observe(greet);
  scene && ro.observe(scene);
})();
</script>

<!-- add-photos：可多次打開、累加上傳、依剩餘名額限制 -->
<script>
(() => {
  const trigger  = document.getElementById('add-photos-trigger');
  const sheet    = document.getElementById('add-photos-sheet');
  const btnX     = document.getElementById('add-photos-Close');
  const saveBtn  = document.getElementById('add-photos-save');
  const countEl  = document.getElementById('ap-count');
  const uploadedCounter = document.getElementById('uploaded-counter');
  const uploadedThumbs  = document.getElementById('uploaded-thumbs');
  if (!trigger || !sheet) return;

  const triggerWrap = trigger; // 已不再需要外層 <a>
  const maxPick = parseInt(sheet.dataset.max || '3', 10);

  let backdrop = null;
  let selected = []; // 當次選取（li 節點）
  let lastActive = null; // 焦點回復

  function setTriggerDisabled(disabled){
    if (!trigger) return;
    trigger.hidden = disabled;
    if (disabled) {
      trigger.setAttribute('aria-disabled','true');
      trigger.setAttribute('tabindex','-1');
    } else {
      trigger.removeAttribute('aria-disabled');
      trigger.removeAttribute('tabindex');
    }
  }

  const getUploadedCount = () => uploadedThumbs && !uploadedThumbs.hidden
    ? uploadedThumbs.querySelectorAll('img').length : 0;
  const getRemaining = () => Math.max(0, maxPick - getUploadedCount());

  function updateTriggerVisibility(){
    triggerWrap.hidden = (getRemaining() <= 0);
  }
  updateTriggerVisibility();

  function ensureMounted(){
    if(sheet.parentElement !== document.body) document.body.appendChild(sheet);
    if(!backdrop){
      backdrop = document.createElement('div');
      backdrop.className = 'sheet-backdrop';
      backdrop.addEventListener('click', closeSheet, {passive:true});
      document.body.appendChild(backdrop);
    }
  }
  function setHeight(){
    const want = parseInt(sheet.dataset.sheetH || '589', 10);
    const vh = window.innerHeight, gap = 8;
    sheet.style.setProperty('--sheet-h', Math.min(want, vh - gap) + 'px');
  }
  function clearSelections(){
    selected.forEach(li => { li.classList.remove('selected'); li.querySelector('.sel-badge')?.remove(); });
    selected = [];
  }
  function openSheet(e){
    e?.preventDefault?.();
    if(getRemaining() <= 0) return;
    lastActive = document.activeElement;     // ★ 記錄焦點
    ensureMounted();
    setHeight();
    sheet.style.display = '';
    requestAnimationFrame(() => {
      backdrop.classList.add('show');
      sheet.classList.add('is-open');
      sheet.setAttribute('aria-hidden','false');
      document.body.classList.add('no-scroll');
      clearSelections();
      countEl.textContent = '0';
      saveBtn.setAttribute('disabled','true');
      sheet.focus();                          // ★ 對話框取得焦點
    });
  }
  function closeSheet(){
    sheet.classList.remove('is-open');
    sheet.setAttribute('aria-hidden','true');
    backdrop && backdrop.classList.remove('show');
    document.body.classList.remove('no-scroll');
    lastActive?.focus?.();                   // ★ 回復焦點
  }
  sheet.addEventListener('transitionend', (e) => {
    if(e.propertyName === 'bottom' && !sheet.classList.contains('is-open')){
      sheet.style.display = 'none';
    }
  });
  trigger.addEventListener('click', openSheet, {passive:false});
  btnX && btnX.addEventListener('click', closeSheet, {passive:true});
  window.addEventListener('keydown', (e) => {
    if(e.key === 'Escape' && sheet.classList.contains('is-open')) closeSheet();
  }, {passive:true});
  const remeasure = () => sheet.classList.contains('is-open') && setHeight();
  window.addEventListener('resize', remeasure, {passive:true});
  window.addEventListener('orientationchange', () => setTimeout(remeasure, 50), {passive:true});

  // Grid 選取（依剩餘名額限制）
  const grid = sheet.querySelector('.ap-grid');
  grid.addEventListener('click', (e) => {
    const li = e.target.closest('li'); if(!li) return;

    const idx = selected.indexOf(li);
    if(idx >= 0){
      selected.splice(idx, 1);
      li.classList.remove('selected');
      li.querySelector('.sel-badge')?.remove();
    }else{
      const remaining = getRemaining();
      if (remaining <= 0) return;
      if (selected.length >= remaining) return;
      selected.push(li);
      li.classList.add('selected');
      const badge = document.createElement('span');
      badge.className = 'sel-badge';
      badge.textContent = String(selected.length);
      li.appendChild(badge);
    }

    selected.forEach((el, i) => { el.querySelector('.sel-badge').textContent = String(i+1); });
    countEl.textContent = String(selected.length);
    saveBtn.toggleAttribute('disabled', selected.length === 0);
  });

  // 確認上傳（累加，不覆蓋）
  saveBtn.addEventListener('click', () => {
    if (!uploadedThumbs) return;
    const remaining = getRemaining();
    if (remaining <= 0 || selected.length === 0) { closeSheet(); return; }

    const addN = Math.min(remaining, selected.length);
    const frag = document.createDocumentFragment();
    for (let i = 0; i < addN; i++) {
      const src = selected[i].querySelector('img')?.getAttribute('src');
      if (!src) continue;
      const wrap = document.createElement('div');
      const img  = new Image();
      img.src = src;
      img.alt = '已上傳的照片縮圖';
      wrap.appendChild(img);
      frag.appendChild(wrap);
    }
    uploadedThumbs.appendChild(frag);
    uploadedThumbs.hidden = false;

    const now = getUploadedCount();
    uploadedCounter && (uploadedCounter.textContent = `已上傳 ${now} / ${maxPick} 張`);

    updateTriggerVisibility();
    closeSheet();
    clearSelections();
    countEl.textContent = '0';
    saveBtn.setAttribute('disabled','true');
    lastActive = document.activeElement;
    btnX?.focus();
  });
})();
</script>




</body>
</html>
