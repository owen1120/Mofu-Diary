<!--myday-diary-template.ejs  -->
<p class="fs-12 text-primary-700 mb-0">你可以在這裡設定日記主題</p> <!--p的通用樣式可能錯了-->
<p class="fs-12 text-primary-700 mb-2">書寫可以幫助你釋放情緒與思緒 好好結束一天</p><!--p的通用樣式可能錯了-->
<div id="topicContainer" class="d-flex flex-wrap gap-3 mb-3">
  <button type="button" class="fs-12 p-3 btn topic-btn text-primary-500 border-primary-500 border border-1 rounded-1" data-bs-toggle="button">日常生活</button>
  <button type="button" class="fs-12 p-3 btn topic-btn text-primary-500 border-primary-500 border border-1 rounded-1" data-bs-toggle="button">感謝的事</button>
  <button type="button" class="fs-12 p-3 btn topic-btn text-primary-500 border-primary-500 border border-1 rounded-1" data-bs-toggle="button">今日成就</button>
  <button type="button" class="fs-12 p-3 btn topic-btn text-primary-500 border-primary-500 border border-1 rounded-1" data-bs-toggle="button">重要的事</button>
  <button type="button" class="fs-12 p-3 btn topic-btn text-primary-500 border-primary-500 border border-1 rounded-1" data-bs-toggle="button">很棒的事</button>
  <button type="button" class="fs-12 p-3 btn topic-btn text-primary-500 border-primary-500 border border-1 rounded-1" data-bs-toggle="button">其他</button>
  <button type="button" 
    class="fs-12 p-3 btn topic-btn topic-btn-custom text-primary-500 border-primary-500 border border-1 rounded-1" 
    data-bs-toggle="modal"
    data-bs-target="#topicCustomModal">
    ＋ 自訂
  </button> 
</div>
<a class="d-flex align-items-center text-primary-700" href="settingTemplate.html">
  <p class="fs-12 mb-0">前往設定</p>
  <p class="fs-12 fw-bold mb-0">筆記模板</p>
</a>

<!-- 自訂主題 Modal -->
<div class="modal fade" id="topicCustomModal" 
  tabindex="-1" aria-labelledby="topicCustomModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-neutral-0 rounded-s border-0 p-0">
      <div class="modal-body px-4 py-3">
        <h5 class="fs-11 text-primary-700 text-start" id="topicCustomModalLabel">自訂日記主題</h5>
        <div class="d-flex mb-2 bg-neutral-0">
          <input id="topicCustomInput" type="text" 
            class="form-control rounded-3 px-6 py-3 me-2" 
            maxlength="5" placeholder="最多 5 字">
          <button type="button" 
          class="btn rounded-3 btn-primary-700 text-neutral-0 py-3 px-5 text-nowrap" 
          id="topicCustomConfirm" disabled>確認</button>
        </div>
        <div class="form-text text-neutral-400 text-start">上限
          <span id="topicCustomCount">0</span>/ 5字
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // 允許沒有 topicContainer 時仍能新增卡片
  const container = document.getElementById('topicContainer');

  const modalEl   = document.getElementById('topicCustomModal');
  const inputEl   = document.getElementById('topicCustomInput');
  const countEl   = document.getElementById('topicCustomCount');
  const confirmEl = document.getElementById('topicCustomConfirm');
  if (!modalEl || !inputEl || !countEl || !confirmEl) return;

  // Modal 掛到 body，避免抽屜層級影響
  if (modalEl.parentElement !== document.body) document.body.appendChild(modalEl);

  const bsModal = window.bootstrap?.Modal.getOrCreateInstance(modalEl, {
    backdrop:true, keyboard:true, focus:true
  });

  // —— 新增：slugify 與建立卡片 —— //
  function slugify(s){
    return s.toLowerCase()
      .replace(/[^\p{L}\p{N}]+/gu,'-')
      .replace(/^-+|-+$/g,'')
      .slice(0,24);
  }
  function createDiaryCard(title){
    const accRoot = document.getElementById('accordionFlushExample');
    if (!accRoot) return;
    const uid = 'flush-' + slugify(title || 'custom') + '-' + Date.now().toString(36).slice(-4);

    const item = document.createElement('div');
    item.className = 'accordion-item rounded-top-m rounded-bottom-xs pb-4 pt-0 px-5';
    item.innerHTML = `
      <h2 class="accordion-header">
        <button class="accordion-button collapsed fs-11 text-primary-700 fw-medium p-0"
                type="button" data-bs-toggle="collapse"
                data-bs-target="#${uid}" aria-controls="${uid}" aria-expanded="false">
          ${title}
        </button>
      </h2>
      <div id="${uid}" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
        <div class="accordion-body p-0">
          <textarea class="form-control rounded-3 text-primary-700 diary-textarea shadow-mini"
                    data-section="daily" placeholder="請輸入文字"></textarea>
          <div class="saved-list mt-2"></div>
        </div>
      </div>`;
    // 追加到最後，讓它成為新的 :last-child → 收折時吃漸層
    accRoot.appendChild(item);
    // 通知群組控制刷新
    accRoot.dispatchEvent(new Event('accordion:updated'));
  }
  // —— 新增結束 —— //

  modalEl.addEventListener('shown.bs.modal', () => {
    inputEl.value = '';
    countEl.textContent = '0';
    confirmEl.disabled = true;
    inputEl.focus();
  });
  inputEl.addEventListener('input', () => {
    const v = inputEl.value.trim();
    countEl.textContent = v.length;
    confirmEl.disabled = (v.length === 0);
  });
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !confirmEl.disabled) confirmEl.click();
  });

  confirmEl.addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation();
    const text = inputEl.value.trim();
    if (!text) return;

    // 有主題容器才新增按鈕；沒有就略過，不中止流程
    if (container) {
      const anchor = container.querySelector('.topic-btn-custom')
                || container.querySelector('[data-bs-target="#topicCustomModal"]');
      const exists = Array.from(container.querySelectorAll('.topic-btn, .topic-btn-custom'))
                    .some(b => b.textContent.trim() === text);
      if (!exists && anchor) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'fs-12 p-3 btn topic-btn text-primary-500 border-primary-500 border border-1 rounded-1';
        btn.setAttribute('data-bs-toggle', 'button');
        btn.textContent = text;
        container.insertBefore(btn, anchor);
      }
    }

    // ☆ 關鍵：同步在預覽區新增一張卡片（成為新的最外層）
    createDiaryCard(text);

    bsModal?.hide();
    document.getElementById('relaxPanel')?.classList.add('is-open');
    window.dispatchEvent(new Event('resize'));
  });
});
</script>