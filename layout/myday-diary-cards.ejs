<!--myday-diary-cards.ejs  -->
<div class="accordion accordion-flush mb-2" id="accordionFlushExample">
  <div class="accordion-item rounded-top-m rounded-bottom-xs py-4 px-5">
    <h2 class="accordion-header mb-2">
      <button class="accordion-button collapsed fs-11 text-primary-700 fw-medium p-0" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
        日常生活
      </button>
    </h2>
    <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
      <div class="accordion-body p-0">
        <!-- ★ 改 textarea；加 data-section 與類名 -->
        <textarea
          class="form-control rounded-3 text-primary-700 diary-textarea shadow-mini"
          data-section="daily"
          placeholder="請輸入文字"></textarea>
        <!-- ★ 儲存後會把文字插在這裡 -->
        <div class="saved-list mt-2"></div>
      </div>
    </div>
  </div>
  <div class="accordion-item rounded-top-m rounded-bottom-xs py-4 px-5">
    <h2 class="accordion-header mb-2">
      <button class="accordion-button collapsed fs-11 text-primary-700 fw-medium p-0" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
        感謝的事
      </button>
    </h2>
    <div id="flush-collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
      <div class="accordion-body p-0">
        <!-- ★ 改 textarea；加 data-section 與類名 -->
        <textarea
          class="form-control rounded-3 text-primary-700 diary-textarea shadow-mini"
          data-section="daily"
          placeholder="請輸入文字"></textarea>
        <!-- ★ 儲存後會把文字插在這裡 -->
        <div class="saved-list mt-2"></div> 
      </div>
    </div>
  </div>
  <div class="accordion-item rounded-top-m rounded-bottom-xs py-4 px-5">
    <h2 class="accordion-header mb-2">
      <button class="accordion-button collapsed fs-11 text-primary-700 fw-medium p-0" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseThree" aria-expanded="false" aria-controls="flush-collapseThree">
        其他
      </button>
    </h2>
    <div id="flush-collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
      <div class="accordion-body p-0"> 
        <!-- ★ 改 textarea；加 data-section 與類名 -->
        <textarea
          class="form-control rounded-3 text-primary-700 diary-textarea shadow-mini"
          data-section="daily"
          placeholder="請輸入文字"></textarea>
        <!-- ★ 儲存後會把文字插在這裡 -->
        <div class="saved-list mt-2"></div>                 
      </div>
    </div>
  </div>
</div>


<script>
/* ★修正版：點任一標題，全數展開/收合；展開時加 .acc-open */
(function(){
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const accRoot = document.getElementById('accordionFlushExample');
  if (!accRoot) return;

  const Bootstrap = window.bootstrap;
  const items = $$('#accordionFlushExample .accordion-collapse');
  const instances = items.map(el => Bootstrap?.Collapse?.getOrCreateInstance(el, { toggle:false }) || null);

  const isAllShown = () => items.every(el => el.classList.contains('show'));

  function setAll(open){
    if (instances.some(Boolean)) {
      instances.forEach(inst => open ? inst.show() : inst.hide());
    } else {
      /* ★Fallback：即使沒載入 Bootstrap JS 也能運作 */
      items.forEach(el => {
        el.classList.toggle('show', open);
        el.style.height = open ? 'auto' : '';
      });
      $$('#accordionFlushExample .accordion-button').forEach(btn => {
        btn.classList.toggle('collapsed', !open);
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    }
    accRoot.classList.toggle('acc-open', open);
  }

  /* 點任一 header → 群組切換 */
  accRoot.addEventListener('click', (e) => {
    const btn = e.target.closest('.accordion-button');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    setAll(!isAllShown());
  });

  /* 同步旗標（有載 Bootstrap 時生效） */
  accRoot.addEventListener('shown.bs.collapse', () => accRoot.classList.toggle('acc-open', isAllShown()));
  accRoot.addEventListener('hidden.bs.collapse', () => accRoot.classList.toggle('acc-open', isAllShown()));

  // ★ 保留你的儲存功能
  const saveBtn = document.getElementById('saveDiaryBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
      const areas = $$('#accordionFlushExample .diary-textarea');
      areas.forEach(area => {
        const text = area.value.trim();
        if (!text) return;
        const body = area.closest('.accordion-body');
        const list = $('.saved-list', body);
        if (!list) return;

        const entry = document.createElement('div');
        entry.className = 'diary-entry';
        entry.textContent = text; // CSS 用 pre-wrap 保留換行
        list.appendChild(entry);

        // 若要存檔後清空輸入 → 打開下一行
        // area.value = '';
      });

      // 抽屜內容變高時，讓量測重算
      window.dispatchEvent(new Event('resize'));
    });
  }
})();
</script>