<!--myday-diary-cards.ejs  -->
<div class="accordion accordion-flush mb-2" id="accordionFlushExample">
  <div class="accordion-item rounded-top-m rounded-bottom-xs pb-4 pt-0 px-5">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed fs-11 text-primary-700 fw-medium p-0" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
        日常生活
      </button>
    </h2>
    <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
      <div class="accordion-body p-0">
        <!-- ★ 改 textarea；加 data-section 與類名 -->
        <textarea
          class="form-control rounded-3 text-primary-700 diary-textarea shadow-mini"
          data-section="daily"
          placeholder="請輸入文字"></textarea>
        <!-- ★ 儲存後會把文字插在這裡 -->
        <div class="saved-list mt-2"></div>
      </div>
    </div>
  </div>
  <div class="accordion-item rounded-top-m rounded-bottom-xs pb-4 pt-0 px-5">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed fs-11 text-primary-700 fw-medium p-0" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
        感謝的事
      </button>
    </h2>
    <div id="flush-collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
      <div class="accordion-body p-0">
        <!-- ★ 改 textarea；加 data-section 與類名 -->
        <textarea
          class="form-control rounded-3 text-primary-700 diary-textarea shadow-mini"
          data-section="daily"
          placeholder="請輸入文字"></textarea>
        <!-- ★ 儲存後會把文字插在這裡 -->
        <div class="saved-list mt-2"></div> 
      </div>
    </div>
  </div>
  <div class="accordion-item rounded-top-m rounded-bottom-xs pb-4 pt-0 px-5">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed fs-11 text-primary-700 fw-medium p-0" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseThree" aria-expanded="false" aria-controls="flush-collapseThree">
        其他
      </button>
    </h2>
    <div id="flush-collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
      <div class="accordion-body p-0"> 
        <!-- ★ 改 textarea；加 data-section 與類名 -->
        <textarea
          class="form-control rounded-3 text-primary-700 diary-textarea shadow-mini"
          data-section="daily"
          placeholder="請輸入文字"></textarea>
        <!-- ★ 儲存後會把文字插在這裡 -->
        <div class="saved-list mt-2"></div>                 
      </div>
    </div>
  </div>
</div>


<script>
/* 動態版：新增卡片後自動納入群組展開/收合 */
(function(){
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const accRoot = document.getElementById('accordionFlushExample');
  if (!accRoot) return;

  const Bootstrap = window.bootstrap;
  const instMap = new Map(); // el => Collapse instance

  function collapses(){ return $$('#accordionFlushExample .accordion-collapse'); }
  function buttons(){ return $$('#accordionFlushExample .accordion-button'); }

  function ensureInstances(){
    const els = collapses();
    if (!Bootstrap?.Collapse) return els;
    els.forEach(el => {
      if (!instMap.has(el)) {
        instMap.set(el, Bootstrap.Collapse.getOrCreateInstance(el, { toggle:false }));
      }
    });
    for (const el of [...instMap.keys()]) if (!el.isConnected) instMap.delete(el);
    return els;
  }

  const isAllShown = () => collapses().every(el => el.classList.contains('show'));

  function setAll(open){
    if (instMap.size > 0) {
      for (const inst of instMap.values()) open ? inst.show() : inst.hide();
    } else {
      collapses().forEach(el => {
        el.classList.toggle('show', open);
        el.style.height = open ? 'auto' : '';
      });
      buttons().forEach(btn => {
        btn.classList.toggle('collapsed', !open);
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    }
    accRoot.classList.toggle('acc-open', open);
  }

  function syncFlag(){ accRoot.classList.toggle('acc-open', isAllShown()); }

  ensureInstances();

  accRoot.addEventListener('click', (e) => {
    const btn = e.target.closest('.accordion-button');
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    setAll(!isAllShown());
  });

  accRoot.addEventListener('shown.bs.collapse', syncFlag);
  accRoot.addEventListener('hidden.bs.collapse', syncFlag);

  // 新卡片進場時刷新
  const mo = new MutationObserver(() => { ensureInstances(); syncFlag(); });
  mo.observe(accRoot, { childList:true, subtree:true });

  // 接收外部通知
  accRoot.addEventListener('accordion:updated', () => { ensureInstances(); syncFlag(); });
})();
</script>